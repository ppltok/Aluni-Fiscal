<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תמיכות ותקציב | ויזואליזציה</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-purple: #a371f7;
            --accent-orange: #d29922;
            --accent-red: #f85149;
            --accent-pink: #db61a2;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f6f8fa;
            --bg-tertiary: #f0f2f5;
            --border-color: #d0d7de;
            --text-primary: #1f2328;
            --text-secondary: #656d76;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Heebo', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 60px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            z-index: 1000;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar.expanded { width: 280px; }

        .sidebar-toggle {
            width: 100%;
            padding: 20px;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-nav { padding: 10px 0; flex: 1; overflow-y: auto; }

        .sidebar-nav-item { list-style: none; }

        .sidebar-nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            gap: 15px;
        }

        .sidebar-nav-link:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .sidebar-nav-link.active {
            color: var(--accent-blue);
            background: rgba(88, 166, 255, 0.1);
        }

        .sidebar-nav-icon { font-size: 20px; min-width: 24px; text-align: center; }

        .sidebar-nav-text { display: none; }
        .sidebar.expanded .sidebar-nav-text { display: block; }

        .sidebar-nav-label { font-size: 14px; font-weight: 500; }
        .sidebar-nav-desc { font-size: 11px; color: var(--text-secondary); }

        /* Main content */
        .main-content {
            margin-right: 60px;
            padding: 30px;
            transition: margin-right 0.3s ease;
        }

        body.sidebar-expanded .main-content { margin-right: 280px; }

        /* Header */
        .page-header {
            max-width: 1600px;
            margin: 0 auto 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 28px;
            font-weight: 600;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 5px;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .year-select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Heebo', sans-serif;
            font-size: 14px;
            cursor: pointer;
        }

        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 18px;
        }

        /* Stats cards */
        .stats-row {
            max-width: 1600px;
            margin: 0 auto 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
        }

        .stat-value.blue { color: var(--accent-blue); }
        .stat-value.green { color: var(--accent-green); }
        .stat-value.red { color: var(--accent-red); }
        .stat-value.orange { color: var(--accent-orange); }
        .stat-value.purple { color: var(--accent-purple); }

        /* Utilization gauge */
        .gauge-container {
            max-width: 1600px;
            margin: 0 auto 30px;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .gauge-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
        }

        .gauge-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gauge-chart {
            height: 250px;
        }

        /* Chart container */
        .chart-section {
            max-width: 1600px;
            margin: 0 auto 30px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            height: 500px;
        }

        /* Recipients table */
        .recipients-section {
            max-width: 1600px;
            margin: 0 auto 30px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
        }

        .recipients-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .recipients-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: 'Heebo', sans-serif;
            font-size: 14px;
            width: 300px;
        }

        .recipients-table {
            width: 100%;
            border-collapse: collapse;
        }

        .recipients-table th,
        .recipients-table td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }

        .recipients-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .recipients-table tr:hover {
            background: var(--bg-tertiary);
        }

        .recipients-table .amount {
            font-weight: 600;
            color: var(--accent-green);
        }

        .recipients-table .budget-code {
            font-family: monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Treemap section */
        .treemap-section {
            max-width: 1600px;
            margin: 0 auto 30px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
        }

        .treemap-container {
            height: 600px;
        }

        /* Over-budget alerts */
        .alerts-section {
            max-width: 1600px;
            margin: 0 auto 30px;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(248, 81, 73, 0.05) 100%);
            border: 2px solid var(--accent-red);
            border-radius: 16px;
            padding: 30px;
        }

        .alerts-header {
            margin-bottom: 25px;
        }

        .alerts-title {
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--accent-red);
        }

        .alerts-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
            margin-right: 42px;
        }

        .alert-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .alert-item {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
        }

        .alert-item:hover {
            border-color: var(--accent-red);
        }

        .alert-item-info {
            flex: 1;
        }

        .alert-item-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .alert-item-details {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .alert-item-values {
            text-align: left;
            min-width: 200px;
        }

        .alert-budget {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .alert-paid {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-red);
        }

        .alert-excess {
            font-size: 12px;
            color: var(--accent-orange);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-family: 'Heebo', sans-serif;
        }

        .pagination button:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            padding: 8px 16px;
            color: var(--text-secondary);
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 0;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 4px;
        }

        .view-toggle-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Heebo', sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .view-toggle-btn:hover {
            color: var(--text-primary);
        }

        .view-toggle-btn.active {
            background: var(--accent-blue);
            color: white;
        }

        /* Orphan codes section */
        .orphan-section {
            max-width: 1600px;
            margin: 0 auto 30px;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(210, 153, 34, 0.05) 100%);
            border: 2px solid var(--accent-orange);
            border-radius: 16px;
            padding: 30px;
        }

        .orphan-title {
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--accent-orange);
            margin-bottom: 10px;
        }

        .orphan-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .orphan-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .orphan-stat {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .orphan-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-orange);
        }

        .orphan-stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <button class="sidebar-toggle" id="sidebarToggle" title="הרחב/כווץ תפריט">&#9776;</button>
        <ul class="sidebar-nav">
            <li class="sidebar-nav-item">
                <a href="budget_interactive.html" class="sidebar-nav-link">
                    <span class="sidebar-nav-icon">&#9641;</span>
                    <div class="sidebar-nav-text">
                        <div class="sidebar-nav-label">תקציב המדינה</div>
                        <div class="sidebar-nav-desc">תצוגה היררכית</div>
                    </div>
                </a>
            </li>
            <li class="sidebar-nav-item">
                <a href="time_series.html" class="sidebar-nav-link">
                    <span class="sidebar-nav-icon">&#128200;</span>
                    <div class="sidebar-nav-text">
                        <div class="sidebar-nav-label">השוואה שנתית</div>
                        <div class="sidebar-nav-desc">מגמות לאורך זמן</div>
                    </div>
                </a>
            </li>
            <li class="sidebar-nav-item">
                <a href="salary_percentage.html" class="sidebar-nav-link">
                    <span class="sidebar-nav-icon">&#8362;</span>
                    <div class="sidebar-nav-text">
                        <div class="sidebar-nav-label">אחוזי שכר</div>
                        <div class="sidebar-nav-desc">גמישות תקציבית</div>
                    </div>
                </a>
            </li>
            <li class="sidebar-nav-item">
                <a href="ministry_overview.html" class="sidebar-nav-link">
                    <span class="sidebar-nav-icon">&#9962;</span>
                    <div class="sidebar-nav-text">
                        <div class="sidebar-nav-label">סקירת משרדים</div>
                        <div class="sidebar-nav-desc">השוואה בין משרדים</div>
                    </div>
                </a>
            </li>
            <li class="sidebar-nav-item">
                <a href="sunburst_budget.html" class="sidebar-nav-link">
                    <span class="sidebar-nav-icon">&#9788;</span>
                    <div class="sidebar-nav-text">
                        <div class="sidebar-nav-label">Sunburst</div>
                        <div class="sidebar-nav-desc">תרשים שמש היררכי</div>
                    </div>
                </a>
            </li>
            <li class="sidebar-nav-item">
                <a href="five_pillars.html" class="sidebar-nav-link">
                    <span class="sidebar-nav-icon">&#9733;</span>
                    <div class="sidebar-nav-text">
                        <div class="sidebar-nav-label">5 עמודי התקציב</div>
                        <div class="sidebar-nav-desc">ניתוח הוצאות ליבה</div>
                    </div>
                </a>
            </li>
            <li class="sidebar-nav-item">
                <a href="paid_supports.html" class="sidebar-nav-link active">
                    <span class="sidebar-nav-icon">&#128176;</span>
                    <div class="sidebar-nav-text">
                        <div class="sidebar-nav-label">תמיכות ותקציב</div>
                        <div class="sidebar-nav-desc">ביצוע מול תקציב</div>
                    </div>
                </a>
            </li>
            <li class="sidebar-nav-item">
                <a href="convergent_sankey.html" class="sidebar-nav-link">
                    <span class="sidebar-nav-icon">&#8644;</span>
                    <div class="sidebar-nav-text">
                        <div class="sidebar-nav-label">מבחני תמיכה</div>
                        <div class="sidebar-nav-desc">מקבלים → תקנה → תקציב</div>
                    </div>
                </a>
            </li>
            <li class="sidebar-nav-item">
                <a href="budget_rigidity.html" class="sidebar-nav-link">
                    <span class="sidebar-nav-icon">&#128274;</span>
                    <div class="sidebar-nav-text">
                        <div class="sidebar-nav-label">מד קשיחות</div>
                        <div class="sidebar-nav-desc">גמישות תקציבית</div>
                    </div>
                </a>
            </li>
        </ul>
    </aside>

    <div class="main-content">
        <!-- Header -->
        <div class="page-header">
            <div>
                <h1 class="page-title">תמיכות ותקציב</h1>
                <p class="page-subtitle">ניתוח ביצוע תקציבי - כמה שולם מתוך התקציב המוקצה</p>
            </div>
            <div class="controls">
                <select class="year-select" id="yearSelect"></select>
                <button class="theme-toggle" id="themeToggle" title="החלף מצב תצוגה">&#9790;</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">תקציב מוקצה</div>
                <div class="stat-value blue" id="totalBudget">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">סה"כ שולם</div>
                <div class="stat-value green" id="totalPaid">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">אחוז ניצול</div>
                <div class="stat-value purple" id="utilizationRate">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">מספר מקבלים</div>
                <div class="stat-value orange" id="recipientCount">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">חריגות תקציב</div>
                <div class="stat-value red" id="overBudgetCount">--</div>
            </div>
        </div>

        <!-- Utilization Gauge -->
        <div class="gauge-container">
            <div class="gauge-card">
                <div class="gauge-title">
                    <span>&#128202;</span>
                    אחוז ניצול תקציב
                </div>
                <div class="gauge-chart" id="gaugeChart"></div>
            </div>
            <div class="gauge-card">
                <div class="gauge-title">
                    <span>&#128200;</span>
                    התפלגות ניצול לפי משרד
                </div>
                <div class="gauge-chart" id="ministryChart"></div>
            </div>
        </div>

        <!-- Sunburst Chart -->
        <div class="treemap-section">
            <div class="chart-title">
                <span>&#9788;</span>
                מבנה היררכי של התמיכות (Sunburst)
            </div>
            <div class="treemap-container" id="sunburstChart"></div>
        </div>

        <!-- Over-budget alerts -->
        <div class="alerts-section" id="alertsSection">
            <div class="alerts-header">
                <div class="alerts-title">
                    <span>&#9888;</span>
                    חריגות תקציב
                </div>
                <div class="alerts-subtitle">תקנות שבהן התשלום בפועל עלה על התקציב המוקצה</div>
            </div>
            <div class="alert-list" id="alertList"></div>
        </div>

        <!-- Orphan codes section -->
        <div class="orphan-section" id="orphanSection">
            <div class="orphan-title">
                <span>&#128269;</span>
                קודים ללא התאמה בתקציב
            </div>
            <div class="orphan-subtitle">תשלומים שבוצעו עבור קודי תקנה שאינם מופיעים בקובץ התקציב לשנה זו</div>
            <div class="orphan-stats">
                <div class="orphan-stat">
                    <div class="orphan-stat-value" id="orphanCount">--</div>
                    <div class="orphan-stat-label">רשומות</div>
                </div>
                <div class="orphan-stat">
                    <div class="orphan-stat-value" id="orphanAmount">--</div>
                    <div class="orphan-stat-label">סכום כולל</div>
                </div>
                <div class="orphan-stat">
                    <div class="orphan-stat-value" id="orphanCodes">--</div>
                    <div class="orphan-stat-label">קודים ייחודיים</div>
                </div>
            </div>
        </div>

        <!-- Recipients table -->
        <div class="recipients-section">
            <div class="recipients-header">
                <div class="recipients-title">
                    <span>&#128101;</span>
                    רשימת מקבלי תמיכות
                </div>
                <input type="text" class="search-box" id="searchBox" placeholder="חיפוש לפי שם מקבל או קוד תקנה...">
            </div>
            <table class="recipients-table">
                <thead>
                    <tr>
                        <th>שם מקבל</th>
                        <th>קוד תקנה</th>
                        <th>שם תקנה</th>
                        <th>משרד</th>
                        <th>סכום ששולם</th>
                        <th>שנת בקשה</th>
                    </tr>
                </thead>
                <tbody id="recipientsBody"></tbody>
            </table>
            <div class="pagination">
                <button id="prevPage" onclick="changePage(-1)">&#8594; הקודם</button>
                <span class="page-info" id="pageInfo">עמוד 1 מתוך 1</span>
                <button id="nextPage" onclick="changePage(1)">הבא &#8592;</button>
            </div>
        </div>
    </div>

    <script>
        // Data placeholders - will be replaced by Python
        const BUDGET_DATA = __BUDGET_DATA_PLACEHOLDER__;
        const PAID_SUPPORTS_DATA = __PAID_SUPPORTS_PLACEHOLDER__;

        const state = {
            currentYear: 2024,
            currentPage: 1,
            pageSize: 50,
            searchTerm: '',
            filteredRecipients: []
        };

        // Initialize
        function init() {
            // Populate year select
            const yearSelect = document.getElementById('yearSelect');
            const years = Object.keys(PAID_SUPPORTS_DATA).map(Number).sort((a, b) => b - a);
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            yearSelect.addEventListener('change', (e) => {
                state.currentYear = parseInt(e.target.value);
                state.currentPage = 1;
                updateView();
            });

            // Search
            document.getElementById('searchBox').addEventListener('input', (e) => {
                state.searchTerm = e.target.value;
                state.currentPage = 1;
                updateRecipientsTable();
            });

            // Theme
            initTheme();
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Sidebar
            initSidebar();
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);

            updateView();
        }

        function updateView() {
            const yearData = PAID_SUPPORTS_DATA[state.currentYear];
            const budgetData = BUDGET_DATA[state.currentYear];
            
            if (!yearData) return;

            // Calculate stats
            const stats = calculateStats(yearData, budgetData);
            updateStats(stats);

            // Draw charts
            drawGaugeChart(stats.utilizationRate);
            drawMinistryChart(yearData, budgetData);
            drawSunburst(yearData, budgetData);

            // Update alerts
            updateAlerts(stats.overBudgetItems);

            // Update orphan section
            updateOrphanSection(yearData);

            // Update recipients table
            state.filteredRecipients = yearData.recipients || [];
            updateRecipientsTable();
        }

        function calculateStats(yearData, budgetData) {
            const stats = {
                totalBudget: 0,
                totalPaid: yearData.totalPaid || 0,
                recipientCount: yearData.recipientCount || 0,
                utilizationRate: 0,
                overBudgetItems: [],
                orphanRecords: yearData.orphanRecords || 0,
                orphanAmount: yearData.orphanAmount || 0
            };

            // Calculate budget total from matched codes
            if (yearData.byCode && budgetData) {
                const budgetByCode = {};
                budgetData.forEach(item => {
                    if (item.code) {
                        budgetByCode[item.code] = (budgetByCode[item.code] || 0) + item.value;
                    }
                });

                Object.entries(yearData.byCode).forEach(([code, data]) => {
                    const budget = budgetByCode[code] || 0;
                    stats.totalBudget += budget;

                    if (data.paid > budget && budget > 0) {
                        stats.overBudgetItems.push({
                            code: code,
                            name: data.name,
                            budget: budget,
                            paid: data.paid,
                            excess: data.paid - budget,
                            excessPercent: ((data.paid - budget) / budget * 100).toFixed(1)
                        });
                    }
                });
            }

            stats.utilizationRate = stats.totalBudget > 0 
                ? (stats.totalPaid / stats.totalBudget * 100) 
                : 0;

            // Sort over-budget items by excess amount
            stats.overBudgetItems.sort((a, b) => b.excess - a.excess);

            return stats;
        }

        function updateStats(stats) {
            document.getElementById('totalBudget').textContent = formatBillions(stats.totalBudget) + 'B ₪';
            document.getElementById('totalPaid').textContent = formatBillions(stats.totalPaid) + 'B ₪';
            document.getElementById('utilizationRate').textContent = stats.utilizationRate.toFixed(1) + '%';
            document.getElementById('recipientCount').textContent = stats.recipientCount.toLocaleString('he-IL');
            document.getElementById('overBudgetCount').textContent = stats.overBudgetItems.length;
        }

        function drawGaugeChart(utilizationRate) {
            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            const textColor = isDark ? '#e6edf3' : '#1f2328';
            const bgColor = isDark ? '#161b22' : '#f6f8fa';

            // Determine color based on utilization
            let gaugeColor = '#3fb950'; // green for normal
            if (utilizationRate > 100) {
                gaugeColor = '#f85149'; // red for over-budget
            } else if (utilizationRate > 90) {
                gaugeColor = '#d29922'; // orange for high
            } else if (utilizationRate < 50) {
                gaugeColor = '#58a6ff'; // blue for low
            }

            const trace = {
                type: 'indicator',
                mode: 'gauge+number',
                value: Math.min(utilizationRate, 150), // Cap at 150% for display
                number: { 
                    suffix: '%',
                    font: { size: 40, color: textColor }
                },
                gauge: {
                    axis: { 
                        range: [0, 150], 
                        tickwidth: 1, 
                        tickcolor: textColor,
                        tickfont: { color: textColor }
                    },
                    bar: { color: gaugeColor },
                    bgcolor: bgColor,
                    borderwidth: 0,
                    steps: [
                        { range: [0, 50], color: 'rgba(88, 166, 255, 0.2)' },
                        { range: [50, 90], color: 'rgba(63, 185, 80, 0.2)' },
                        { range: [90, 100], color: 'rgba(210, 153, 34, 0.2)' },
                        { range: [100, 150], color: 'rgba(248, 81, 73, 0.2)' }
                    ],
                    threshold: {
                        line: { color: '#f85149', width: 4 },
                        thickness: 0.75,
                        value: 100
                    }
                }
            };

            const layout = {
                paper_bgcolor: bgColor,
                font: { color: textColor, family: 'Heebo, sans-serif' },
                margin: { t: 30, b: 30, l: 30, r: 30 }
            };

            Plotly.newPlot('gaugeChart', [trace], layout, { responsive: true, displayModeBar: false });
        }

        function drawMinistryChart(yearData, budgetData) {
            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            const textColor = isDark ? '#e6edf3' : '#1f2328';
            const bgColor = isDark ? '#161b22' : '#f6f8fa';

            // Group by ministry (שם רמה 1)
            const byMinistry = {};
            
            if (yearData.byCode && budgetData) {
                const budgetByCode = {};
                const ministryByCode = {};
                
                budgetData.forEach(item => {
                    if (item.code) {
                        budgetByCode[item.code] = (budgetByCode[item.code] || 0) + item.value;
                        ministryByCode[item.code] = item.path ? item.path[0] : 'לא מוגדר';
                    }
                });

                Object.entries(yearData.byCode).forEach(([code, data]) => {
                    const ministry = ministryByCode[code] || 'לא מוגדר';
                    if (!byMinistry[ministry]) {
                        byMinistry[ministry] = { budget: 0, paid: 0 };
                    }
                    byMinistry[ministry].budget += budgetByCode[code] || 0;
                    byMinistry[ministry].paid += data.paid;
                });
            }

            // Sort by paid amount and take top 10
            const sorted = Object.entries(byMinistry)
                .sort((a, b) => b[1].paid - a[1].paid)
                .slice(0, 10);

            const trace = {
                type: 'bar',
                orientation: 'h',
                y: sorted.map(([name]) => name),
                x: sorted.map(([_, data]) => data.budget > 0 ? (data.paid / data.budget * 100) : 0),
                marker: {
                    color: sorted.map(([_, data]) => {
                        const rate = data.budget > 0 ? (data.paid / data.budget * 100) : 0;
                        if (rate > 100) return '#f85149';
                        if (rate > 90) return '#d29922';
                        if (rate < 50) return '#58a6ff';
                        return '#3fb950';
                    })
                },
                text: sorted.map(([_, data]) => {
                    const rate = data.budget > 0 ? (data.paid / data.budget * 100) : 0;
                    return rate.toFixed(1) + '%';
                }),
                textposition: 'outside',
                hovertemplate: '%{y}<br>ניצול: %{x:.1f}%<extra></extra>'
            };

            const layout = {
                paper_bgcolor: bgColor,
                plot_bgcolor: bgColor,
                font: { color: textColor, family: 'Heebo, sans-serif', size: 12 },
                margin: { t: 10, b: 40, l: 150, r: 60 },
                xaxis: {
                    title: 'אחוז ניצול',
                    gridcolor: isDark ? '#30363d' : '#d0d7de',
                    range: [0, Math.max(120, ...sorted.map(([_, d]) => d.budget > 0 ? d.paid / d.budget * 100 : 0))]
                },
                yaxis: {
                    automargin: true
                },
                shapes: [{
                    type: 'line',
                    x0: 100, x1: 100,
                    y0: -0.5, y1: sorted.length - 0.5,
                    line: { color: '#f85149', width: 2, dash: 'dash' }
                }]
            };

            Plotly.newPlot('ministryChart', [trace], layout, { responsive: true, displayModeBar: false });
        }

        function drawSunburst(yearData, budgetData) {
            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            const textColor = isDark ? '#e6edf3' : '#1f2328';
            const bgColor = isDark ? '#161b22' : '#f6f8fa';

            const container = document.getElementById('sunburstChart');
            if (!yearData.byCode || !budgetData) {
                container.innerHTML = '<p style="text-align:center;padding:50px;">אין נתונים זמינים</p>';
                return;
            }

            // 1. Index Budget Data
            const budgetByCode = {};
            const infoByCode = {};
            budgetData.forEach(item => {
                if (item.code) {
                    budgetByCode[item.code] = (budgetByCode[item.code] || 0) + item.value;
                    infoByCode[item.code] = {
                        path: item.path || [],
                        name: item.name || ''
                    };
                }
            });

            // 2. Build Hierarchy
            const hierarchy = {};
            
            // Helper to sanitize IDs
            function safeId(str) {
                return str.replace(/[^a-zA-Z0-9א-ת0-9 ]/g, '_').replace(/\s+/g, '_');
            }

            function addNode(id, label, parentId, budget, paid, level, isLeaf, code) {
                if (!hierarchy[id]) {
                    hierarchy[id] = {
                        id, label, parent: parentId,
                        budget: 0, paid: 0,
                        level, isLeaf, code
                    };
                }
                hierarchy[id].budget += budget;
                hierarchy[id].paid += paid;
            }

            // Root
            addNode('root', 'תקציב התמיכות', '', 0, 0, 0, false, null);

            Object.entries(yearData.byCode).forEach(([code, data]) => {
                const budgetVal = budgetByCode[code] || 0;
                const paidVal = data.paid;
                const info = infoByCode[code] || { path: [], name: data.name };
                
                // Accumulate to Root
                hierarchy['root'].budget += budgetVal;
                hierarchy['root'].paid += paidVal;

                // Normalize path: remove empty strings
                const path = (info.path || []).filter(p => p);
                
                let currentId = 'root';
                
                // Add path nodes
                path.forEach((name, index) => {
                    const safeName = safeId(name);
                    const nextId = currentId + '__' + safeName;
                    addNode(nextId, name, currentId, budgetVal, paidVal, index + 1, false, null);
                    currentId = nextId;
                });
                
                // Add Code Node
                const codeId = currentId + '__' + code;
                addNode(codeId, data.name || code, currentId, budgetVal, paidVal, path.length + 1, false, code);

                // Add Recipients
                if (yearData.recipientsByCode && yearData.recipientsByCode[code]) {
                    const recipients = [...yearData.recipientsByCode[code]];
                    recipients.sort((a, b) => b.paid - a.paid);
                    
                    const topRecipients = recipients.slice(0, 10);
                    let currentSumThousands = 0;

                    topRecipients.forEach((r, i) => {
                        let rPaidThousands = r.paid / 1000;
                        
                        if (currentSumThousands + rPaidThousands > paidVal) {
                            rPaidThousands = Math.max(0, paidVal - currentSumThousands);
                        }
                        
                        if (rPaidThousands > 0) {
                            currentSumThousands += rPaidThousands;
                            const rId = codeId + '__r' + i;
                            addNode(rId, r.name, codeId, 0, rPaidThousands, path.length + 2, true, code);
                        }
                    });

                    const remainder = paidVal - currentSumThousands;
                    if (remainder > 0.001) {
                         const otherId = codeId + '__others';
                         const otherCount = data.recipients - topRecipients.length;
                         const label = otherCount > 0 ? `אחרים (${otherCount})` : 'אחרים';
                         addNode(otherId, label, codeId, 0, remainder, path.length + 2, true, code);
                    }
                }
            });

            // 3. Convert to Plotly arrays
            const nodes = Object.values(hierarchy);
            
            if (nodes.length <= 1) {
                 container.innerHTML = '<p style="text-align:center;padding:50px;">אין נתונים להצגה</p>';
                 return;
            }
            
            const ids = nodes.map(n => n.id);
            const labels = nodes.map(n => n.label);
            const parents = nodes.map(n => n.parent);
            const values = nodes.map(n => n.paid); // Size by Paid
            
            const customdata = nodes.map(n => {
                let budget = n.budget;
                let utilization = 0;
                
                if (budget > 0) {
                    utilization = n.paid / budget * 100;
                } else if (n.parent && hierarchy[n.parent]) {
                    // Inherit utilization from parent (for recipients)
                    const parent = hierarchy[n.parent];
                    if (parent.budget > 0) {
                        utilization = parent.paid / parent.budget * 100;
                    }
                }
                
                return {
                    budget: budget,
                    paid: n.paid,
                    utilization: utilization,
                    isLeaf: n.isLeaf,
                    code: n.code
                };
            });
            
            const colors = customdata.map(d => {
                const u = d.utilization;
                if (u > 100) return '#f85149';
                if (u > 90) return '#d29922';
                if (u > 70) return '#3fb950';
                if (u > 50) return '#58a6ff';
                return '#8b949e';
            });

            const trace = {
                type: 'sunburst',
                ids: ids,
                labels: labels,
                parents: parents,
                values: values,
                marker: { colors: colors },
                branchvalues: 'total',
                textinfo: 'label+percent entry',
                hovertemplate: '<b>%{label}</b><br>' +
                    'תקציב: %{customdata.budget:,.0f} אלפי ₪<br>' +
                    'שולם: %{customdata.paid:,.0f} אלפי ₪<br>' +
                    'ניצול: %{customdata.utilization:.1f}%<br>' +
                    '<extra></extra>',
                customdata: customdata,
                textfont: { family: 'Heebo, sans-serif' }
            };

            const layout = {
                paper_bgcolor: bgColor,
                font: { color: textColor, family: 'Heebo, sans-serif' },
                margin: { t: 10, b: 10, l: 10, r: 10 },
                sunburstcolorway: ['#58a6ff', '#3fb950', '#a371f7', '#d29922', '#f85149', '#db61a2']
            };

            Plotly.newPlot('sunburstChart', [trace], layout, { responsive: true, displayModeBar: false });
        }

        function updateAlerts(overBudgetItems) {
            const container = document.getElementById('alertList');
            
            if (overBudgetItems.length === 0) {
                document.getElementById('alertsSection').style.display = 'none';
                return;
            }

            document.getElementById('alertsSection').style.display = 'block';

            container.innerHTML = overBudgetItems.slice(0, 20).map(item => `
                <div class="alert-item">
                    <div class="alert-item-info">
                        <div class="alert-item-name">${item.name}</div>
                        <div class="alert-item-details">קוד: ${item.code}</div>
                    </div>
                    <div class="alert-item-values">
                        <div class="alert-budget">תקציב: ${formatMillions(item.budget)}M ₪</div>
                        <div class="alert-paid">שולם: ${formatMillions(item.paid)}M ₪</div>
                        <div class="alert-excess">חריגה: +${item.excessPercent}% (${formatMillions(item.excess)}M ₪)</div>
                    </div>
                </div>
            `).join('');
        }

        function updateOrphanSection(yearData) {
            const orphanRecords = yearData.orphanRecords || 0;
            const orphanAmount = yearData.orphanAmount || 0;
            const orphanCodes = yearData.orphanCodes || 0;

            if (orphanRecords === 0) {
                document.getElementById('orphanSection').style.display = 'none';
                return;
            }

            document.getElementById('orphanSection').style.display = 'block';
            document.getElementById('orphanCount').textContent = orphanRecords.toLocaleString('he-IL');
            document.getElementById('orphanAmount').textContent = formatBillions(orphanAmount) + 'B ₪';
            document.getElementById('orphanCodes').textContent = orphanCodes.toLocaleString('he-IL');
        }

        function updateRecipientsTable() {
            let recipients = state.filteredRecipients;

            // Apply search filter
            if (state.searchTerm) {
                const term = state.searchTerm.toLowerCase();
                recipients = recipients.filter(r => 
                    (r.name && r.name.toLowerCase().includes(term)) ||
                    (r.code && r.code.toString().includes(term)) ||
                    (r.takanName && r.takanName.toLowerCase().includes(term))
                );
            }

            // Pagination
            const totalPages = Math.ceil(recipients.length / state.pageSize);
            const start = (state.currentPage - 1) * state.pageSize;
            const end = start + state.pageSize;
            const pageRecipients = recipients.slice(start, end);

            // Update table
            const tbody = document.getElementById('recipientsBody');
            tbody.innerHTML = pageRecipients.map(r => `
                <tr>
                    <td>${r.name || '-'}</td>
                    <td class="budget-code">${r.code || '-'}</td>
                    <td>${r.takanName || '-'}</td>
                    <td>${r.ministry || '-'}</td>
                    <td class="amount">${formatAmount(r.paid)}</td>
                    <td>${r.requestYear || '-'}</td>
                </tr>
            `).join('');

            // Update pagination
            document.getElementById('pageInfo').textContent = `עמוד ${state.currentPage} מתוך ${totalPages || 1}`;
            document.getElementById('prevPage').disabled = state.currentPage <= 1;
            document.getElementById('nextPage').disabled = state.currentPage >= totalPages;
        }

        function changePage(delta) {
            state.currentPage += delta;
            updateRecipientsTable();
        }

        function formatBillions(value) {
            return (value / 1e6).toFixed(1);
        }

        function formatMillions(value) {
            return (value / 1e3).toFixed(1);
        }

        function formatAmount(value) {
            if (!value) return '-';
            return value.toLocaleString('he-IL') + ' ₪';
        }

        // Theme
        function initTheme() {
            const savedTheme = localStorage.getItem('budget-theme') || 'dark';
            applyTheme(savedTheme);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem('budget-theme', newTheme);
            applyTheme(newTheme);
            updateView();
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('themeToggle').innerHTML = theme === 'dark' ? '&#9790;' : '&#9788;';
        }

        // Sidebar
        function initSidebar() {
            const savedState = localStorage.getItem('sidebar-expanded');
            if (savedState === 'true') {
                document.getElementById('sidebar').classList.add('expanded');
                document.body.classList.add('sidebar-expanded');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('expanded');
            document.body.classList.toggle('sidebar-expanded');
            localStorage.setItem('sidebar-expanded', sidebar.classList.contains('expanded'));
        }

        // Start
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
